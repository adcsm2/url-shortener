# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

URL Shortener API (like bit.ly) built with Express, TypeScript, and PostgreSQL. Portfolio project demonstrating HTTP servers, relational databases, unique ID generation, and API testing.

## Commands

```bash
# Setup
npm install
docker-compose up -d          # Start PostgreSQL
cp .env.example .env
npm run migration:run          # Run TypeORM migrations

# Development
npm run dev                    # Express server with hot reload (ts-node-dev)
npm run build                  # Compile TypeScript to dist/
npm start                      # Run compiled output

# Testing
npm test                       # Jest once
npm run test:watch             # Jest watch mode
npm run test:coverage          # Jest with coverage (threshold: 80%)

# Database
npm run migration:generate -- -n MigrationName
npm run migration:run
npm run migration:revert

# Linting
npm run lint                   # ESLint on src/**/*.ts

# Docker
docker-compose up -d           # Start PostgreSQL container
docker-compose down            # Stop PostgreSQL container
```

## Architecture

```
Express HTTP → Routes → Services → TypeORM Entities → PostgreSQL
```

- **Entry point**: `src/index.ts` — Express setup, middleware, route mounting
- **Routes** (`src/routes/`): HTTP layer only — parse request, call service, return response
  - `POST /api/shorten` → `shorten.ts`
  - `GET /:shortCode` → `redirect.ts` (HTTP 302)
  - `GET /api/stats/:shortCode` → `stats.ts`
- **Services** (`src/services/`): Business logic, database queries via TypeORM repositories
- **Entities** (`src/entities/`): TypeORM entity definitions (maps to PostgreSQL tables)
- **Utils** (`src/utils/`): ID generation with nanoid (7-char URL-safe codes)
- **Middleware** (`src/middleware/`): URL validation, rate limiting
- **Migrations** (`src/migrations/`): TypeORM auto-generated migrations
- **Data source**: `src/data-source.ts` — TypeORM connection config (reads from .env)

## Tech Stack

- **Runtime**: Node.js v20, TypeScript strict mode, CommonJS modules
- **Server**: Express 4.x
- **Database**: PostgreSQL 15 (Docker) + TypeORM 0.3.x
- **ID generation**: nanoid v3 (CommonJS compatible)
- **Testing**: Jest + ts-jest + Supertest (integration tests against API)
- **Validation**: validator library for URL validation

## Conventions

- **TypeScript**: strict mode, no `any`, explicit return types
- **Database**: always use TypeORM — never raw SQL in routes. Entities in `src/entities/`, migrations auto-generated
- **Decorators**: `experimentalDecorators` and `emitDecoratorMetadata` enabled (required by TypeORM)
- **AI-generated code**: mark with `// Generated by Claude Code`

## Git Workflow

This project simulates team collaboration using branches and pull requests:

- **Branch per feature/task**: create a branch from `main` for each piece of work
- **Conventional Commits**: `feat:`, `fix:`, `test:`, `docs:`, `chore:`, `refactor:`
- **Pull Requests**: push branch, create PR via `gh pr create`, merge to `main`
- **Never push directly to main** — always go through a PR

## Key Design Decisions

- **nanoid over hash/auto-increment**: 7-char random codes, cryptographically secure, handles collisions by regenerating
- **PostgreSQL over MongoDB/Redis**: ACID guarantees, unique index on shortCode, relational model for future expansion
- **Duplicate URL handling**: same original URL returns the same shortCode (no duplicates)

## Environment Variables

See `.env.example` — requires: `PORT`, `DB_HOST`, `DB_PORT`, `DB_USERNAME`, `DB_PASSWORD`, `DB_DATABASE`, `BASE_URL`, `SHORT_CODE_LENGTH`
